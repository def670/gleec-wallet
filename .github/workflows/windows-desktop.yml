# .github/workflows/windows-desktop.yml
name: Build Windows x64 (Release)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows (release, auto-retry on coin-assets update)
    runs-on: windows-latest
    timeout-minutes: 60

    env:
      # Use your existing repo secret (you already have this set)
      GITHUB_API_PUBLIC_READONLY_TOKEN: ${{ secrets.GH_API_PUBLIC_READONLY_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter doctor (info)
        shell: pwsh
        run: flutter doctor -v

      # This repo uses path overrides into ./sdk; make sure it exists and is initialized
      - name: Ensure SDK submodule is ready
        shell: pwsh
        run: |
          if (!(Test-Path ".\sdk")) { throw "sdk folder missing. Ensure submodules are checked out." }
          git submodule status

      - name: Pub get
        shell: pwsh
        run: flutter pub get

      # Workaround for the "Coin assets were updated. Re-run the build process..." failure
      - name: Build Windows (attempt 1)
        id: build1
        shell: pwsh
        continue-on-error: true
        run: |
          flutter clean
          flutter pub get
          flutter build windows --release

      - name: Retry build if coin-assets updated
        if: steps.build1.outcome != 'success'
        shell: pwsh
        run: |
          Write-Host "Build attempt 1 failed. Retrying once (common for coin-assets update)..."
          flutter clean
          flutter pub get
          flutter build windows --release

      - name: Package Windows build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path dist | Out-Null

          # Standard Flutter output for Windows desktop release
          $src = "build\windows\x64\runner\Release"
          if (!(Test-Path $src)) { throw "Expected build output not found: $src" }

          $zip = "dist\GleecDEX-windows-x64.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }

          Compress-Archive -Path "$src\*" -DestinationPath $zip
          Write-Host "Created $zip"
          Get-ChildItem dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GleecDEX-windows-x64
          path: dist/GleecDEX-windows-x64.zip
          if-no-files-found: error

      - name: Upload ZIP to GitHub Release (tag builds only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/GleecDEX-windows-x64.zip
