# .github/workflows/windows-desktop.yml
name: Windows Desktop Build (GleecDEX)

on:
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows x64 (Release)
    runs-on: windows-2022

    defaults:
      run:
        shell: bash

    env:
      # Fixes: "GitHub token not set. Some build steps may fail."
      # This is the built-in GitHub Actions token (no extra secret needed).
      GITHUB_API_PUBLIC_READONLY_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Enable long paths (Windows)
        run: |
          git config --global core.longpaths true

      - name: Verify submodules / sdk folder exists
        run: |
          echo "Top-level files:"
          ls -la
          echo ""
          echo "Checking for sdk/packages/komodo_wallet_build_transformer ..."
          if [ ! -d "sdk/packages/komodo_wallet_build_transformer" ]; then
            echo "ERROR: Missing sdk/packages/komodo_wallet_build_transformer"
            echo "Submodules may not have pulled correctly. Showing submodule status:"
            git submodule status || true
            exit 1
          fi
          echo "OK: sdk/packages/komodo_wallet_build_transformer exists."

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.38.6"
          cache: true

      - name: Flutter doctor (for logs)
        run: flutter doctor -v

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Windows (Release) with auto-rebuild on coin asset update
        run: |
          set +e
          flutter build windows --release -v 2>&1 | tee build_windows.log
          EC=${PIPESTATUS[0]}
          set -e

          if [ "$EC" -eq 0 ]; then
            echo "Build succeeded on first attempt."
            exit 0
          fi

          # If the known/expected failure happens, rebuild once.
          if grep -q "Coin assets were updated" build_windows.log; then
            echo "Detected: Coin assets were updated. Running clean + rebuild..."
            flutter clean
            flutter pub get
            flutter build windows --release -v
            exit 0
          fi

          echo "Build failed for an unexpected reason (not coin-assets update)."
          exit "$EC"

      - name: Create ZIP
        run: |
          OUT="GleecDEX-windows-x64.zip"
          cd build/windows/x64/runner/Release
          tar -a -c -f "../../../../${OUT}" .
          cd - >/dev/null
          ls -la "${OUT}"

      - name: Upload artifact (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: GleecDEX-windows-x64
          path: GleecDEX-windows-x64.zip
          if-no-files-found: error
