name: Windows Desktop Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"
  pull_request:
    branches: ["main"]

jobs:
  build-windows:
    name: Build Windows x64 (Release)
    runs-on: windows-latest

    env:
      # Your repo secret (you already created it):
      # Settings -> Secrets and variables -> Actions -> Repository secrets
      # Name: GH_API_PUBLIC_READONLY_TOKEN
      GITHUB_API_PUBLIC_READONLY_TOKEN: ${{ secrets.GH_API_PUBLIC_READONLY_TOKEN }}

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Ensure submodules are initialized
        shell: pwsh
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.38.6"
          cache: true

      - name: Flutter doctor
        shell: pwsh
        run: flutter doctor -v

      - name: Fetch Dart/Flutter packages
        shell: pwsh
        run: flutter pub get

      # IMPORTANT:
      # Your build fails with:
      # "Coin assets were updated... Re-run the build process..."
      # So we do a 2-pass build automatically.
      - name: Build Windows (release, auto-retry on coin-assets update)
        shell: pwsh
        run: |
          $log = "build_windows.log"

          Write-Host "PASS 1 (may fail if coin assets update)"
          flutter build windows --release -v 2>&1 | Tee-Object -FilePath $log

          if ($LASTEXITCODE -ne 0) {
            $txt = Get-Content $log -Raw
            if ($txt -match "Coin assets were updated") {
              Write-Host "Detected coin-assets update. Running PASS 2..."
              flutter build windows --release -v
            } else {
              Write-Error "Build failed for a reason other than coin-assets update."
              exit 1
            }
          }

      - name: Package Windows build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $src = "build/windows/x64/runner/Release"
          if (!(Test-Path $src)) {
            $src = "build/windows/runner/Release"
          }
          if (!(Test-Path $src)) {
            Write-Error "Could not find Release output folder."
            Get-ChildItem -Recurse build/windows | Select-Object -First 200 | Format-List
            exit 1
          }

          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $zip = "dist/GleecDEX-windows-x64.zip"

          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "$src\*" -DestinationPath $zip -Force

          Write-Host "Created $zip"
          Get-ChildItem dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GleecDEX-windows-x64
          path: dist/GleecDEX-windows-x64.zip
          if-no-files-found: error
